name: Weekly IP CN Range Update

on:
  schedule:
    # 每周日晚上10点运行 (UTC时间)
    - cron: '0 12 * * 0'
  workflow_dispatch: # 允许手动触发

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Backup original file
        id: backup
        run: |
          if [ -f range-cn.txt ]; then
            cp range-cn.txt range-cn-backup.txt
            echo "Original file backed up"
          else
            echo "Original file does not exist, first run"
          fi
          
      - name: Download new IP ranges with retry
        id: download
        run: |
          # 方法1: 尝试使用 wget（更稳定）
          echo "Trying wget..."
          if wget -q -O range-cn-temp.txt "https://api.edgeone.ai/ips?version=v4&area=mainland-china"; then
            echo "Download successful using wget"
            exit 0
          fi
          
          # 方法2: 尝试使用 curl 但禁用 HTTP/2
          echo "wget failed, trying curl without HTTP/2..."
          if curl -s --http1.1 "https://api.edgeone.ai/ips?version=v4&area=mainland-china" -o range-cn-temp.txt; then
            echo "Download successful using curl --http1.1"
            exit 0
          fi
          
          # 方法3: 尝试使用 curl 但宽松处理
          echo "curl --http1.1 failed, trying curl with insecure flag..."
          if curl -s -k --http1.1 "https://api.edgeone.ai/ips?version=v4&area=mainland-china" -o range-cn-temp.txt; then
            echo "Download successful using curl -k"
            exit 0
          fi
          
          # 所有方法都失败
          echo "Error: All download methods failed"
          exit 1
          
      - name: Validate downloaded content
        run: |
          # 首先检查文件是否存在
          if [ ! -f range-cn-temp.txt ]; then
            echo "Error: Downloaded file does not exist"
            exit 1
          fi
          
          # 检查文件是否为空
          file_size=$(stat -c%s range-cn-temp.txt 2>/dev/null || stat -f%z range-cn-temp.txt 2>/dev/null || echo "0")
          if [ "$file_size" -eq 0 ]; then
            echo "Error: Downloaded file is empty"
            exit 1
          fi
          
          # 检查文件内容是否包含有效的IP地址格式
          echo "Checking file content..."
          valid_lines=$(grep -E '^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+(/[0-9]+)?$' range-cn-temp.txt | wc -l)
          total_lines=$(wc -l < range-cn-temp.txt)
          
          if [ "$valid_lines" -eq 0 ]; then
            echo "Error: No valid IP addresses found in the file"
            echo "File content (first 10 lines):"
            head -10 range-cn-temp.txt
            exit 1
          fi
          
          if [ "$valid_lines" -lt 10 ]; then
            echo "Warning: Only $valid_lines valid IP ranges found (minimum expected: 10)"
          fi
          
          echo "Validation passed: $valid_lines valid IP ranges out of $total_lines total lines"
          
      - name: Compare with original
        id: compare
        run: |
          # 检查备份文件是否存在
          if [ -f range-cn-backup.txt ]; then
            echo "Comparing new content with original..."
            
            # 清理空白行并排序后比较
            grep -v '^$' range-cn-temp.txt | sort > range-cn-temp-sorted.txt
            grep -v '^$' range-cn-backup.txt | sort > range-cn-backup-sorted.txt
            
            # 检查两个文件是否相同
            if cmp -s range-cn-temp-sorted.txt range-cn-backup-sorted.txt; then
              echo "No changes detected"
              echo "has_changes=false" >> $GITHUB_OUTPUT
              echo "changes_count=0" >> $GITHUB_OUTPUT
            else
              # 获取具体的差异信息
              added_count=$(comm -13 range-cn-backup-sorted.txt range-cn-temp-sorted.txt | wc -l)
              removed_count=$(comm -23 range-cn-backup-sorted.txt range-cn-temp-sorted.txt | wc -l)
              total_changes=$((added_count + removed_count))
              
              echo "Changes detected: +$added_count / -$removed_count (total: $total_changes)"
              echo "has_changes=true" >> $GITHUB_OUTPUT
              echo "changes_count=$total_changes" >> $GITHUB_OUTPUT
              echo "added_count=$added_count" >> $GITHUB_OUTPUT
              echo "removed_count=$removed_count" >> $GITHUB_OUTPUT
              
              # 显示简要差异
              if [ "$added_count" -gt 0 ]; then
                echo "=== Added IP ranges (first 5) ==="
                comm -13 range-cn-backup-sorted.txt range-cn-temp-sorted.txt | head -5
              fi
              
              if [ "$removed_count" -gt 0 ]; then
                echo "=== Removed IP ranges (first 5) ==="
                comm -23 range-cn-backup-sorted.txt range-cn-temp-sorted.txt | head -5
              fi
            fi
            
            # 清理排序文件
            rm -f range-cn-temp-sorted.txt range-cn-backup-sorted.txt
          else
            echo "No original file found, treating as first run"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "changes_count=first_run" >> $GITHUB_OUTPUT
          fi
          
      - name: Update file and commit if changes detected
        if: steps.compare.outputs.has_changes == 'true'
        run: |
          # 更新主文件
          mv range-cn-temp.txt range-cn.txt
          
          # 准备提交信息
          if [ "${{ steps.compare.outputs.changes_count }}" = "first_run" ]; then
            commit_msg="Initial China IP ranges - $(date +'%Y-%m-%d %H:%M:%S UTC')"
          else
            added="${{ steps.compare.outputs.added_count }}"
            removed="${{ steps.compare.outputs.removed_count }}"
            commit_msg="Update China IP ranges (+${added:-0}/-${removed:-0}) - $(date +'%Y-%m-%d %H:%M:%S UTC')"
          fi
          
          # 配置Git并提交
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add range-cn.txt
          git commit -m "$commit_msg"
          git push origin HEAD:${{ github.ref_name }}
          
          echo "✅ File updated and committed successfully"
          
      - name: No changes - clean up
        if: steps.compare.outputs.has_changes == 'false'
        run: |
          echo "No changes detected. Keeping original file."
          echo "Skipping commit..."
          
      - name: Cleanup temporary files
        if: always()
        run: |
          # 清理所有临时文件
          rm -f range-cn-temp.txt range-cn-backup.txt 2>/dev/null || true
          
          echo "Cleanup completed"
